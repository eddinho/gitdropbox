#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

VERSION="0.1.0"

RED=''
GREEN=''
YELLOW=''
NC=''

setup_colors() {
    if [[ -t 1 && -z "${NO_COLOR:-}" ]]; then
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        NC='\033[0m'
    else
        RED=''
        GREEN=''
        YELLOW=''
        NC=''
    fi
}

die() {
    printf '%b\n' "${RED}Error:${NC} $*" >&2
    exit 1
}

warn() {
    printf '%b\n' "${YELLOW}Warning:${NC} $*"
}

ok() {
    printf '%b\n' "${GREEN}$*${NC}"
}

info() {
    printf '%s\n' "$*"
}

expand_tilde() {
    local value="$1"
    case "$value" in
        "~")
            printf '%s\n' "$HOME"
            ;;
        "~/"*)
            printf '%s\n' "$HOME/${value#~/}"
            ;;
        *)
            printf '%s\n' "$value"
            ;;
    esac
}

canonicalize_repo_url() {
    local url="$1"
    case "$url" in
        file://*)
            url="${url#file://}"
            ;;
    esac

    if [[ -d "$url" ]]; then
        (
            cd "$url"
            pwd -P
        )
    else
        printf '%s\n' "$url"
    fi
}

usage() {
    cat << 'EOF'
Usage: gitdropbox [OPTIONS] <project-name>

Create a local project and a bare git repository in Dropbox, then push.

Options:
  -h, --help               Show this help message
  -n, --name NAME          Project name (if not provided, you will be prompted)
  -d, --dev-dir PATH       Local projects folder (default: ~/dev)
  -D, --dropbox-dir PATH   Dropbox git folder (default: ~/Dropbox/Git)
  -b, --branch NAME        Branch name (default: main)
  -r, --remote NAME        Remote name (default: origin)
  -m, --message TEXT       Commit message (default: "Initial commit")
  -f, --force              Allow using an existing non-empty project folder
      --update-remote      Update remote URL if it points somewhere else
      --no-color           Disable colored output
  -V, --version            Show version
      --no-readme          Do not create README.md if missing
      --no-commit          Do not commit or push changes

Configuration (optional):
  git config --global gitdropbox.devdir ~/dev
  git config --global gitdropbox.dropboxdir ~/Dropbox/Git
  git config --global gitdropbox.branch main
  git config --global gitdropbox.remote origin
EOF
}

if [[ "${1:-}" == "--version" || "${1:-}" == "-V" ]]; then
    printf '%s\n' "$VERSION"
    exit 0
fi

if ! command -v git >/dev/null 2>&1; then
    die "Git is not installed or not on PATH."
fi

setup_colors

DEFAULT_DEV_DIR="$HOME/dev"
DEFAULT_DROPBOX_DIR="$HOME/Dropbox/Git"
DEFAULT_BRANCH="main"
DEFAULT_REMOTE="origin"
DEFAULT_COMMIT_MESSAGE="Initial commit"

CFG_DEV_DIR=$(git config --global --get gitdropbox.devdir || true)
CFG_DROPBOX_DIR=$(git config --global --get gitdropbox.dropboxdir || true)
CFG_BRANCH=$(git config --global --get gitdropbox.branch || true)
CFG_REMOTE=$(git config --global --get gitdropbox.remote || true)

DEV_DIR="${GITDROPBOX_DEV_DIR:-${CFG_DEV_DIR:-$DEFAULT_DEV_DIR}}"
DROPBOX_DIR="${GITDROPBOX_DROPBOX_DIR:-${CFG_DROPBOX_DIR:-$DEFAULT_DROPBOX_DIR}}"
BRANCH="${GITDROPBOX_BRANCH:-${CFG_BRANCH:-$DEFAULT_BRANCH}}"
REMOTE_NAME="${GITDROPBOX_REMOTE:-${CFG_REMOTE:-$DEFAULT_REMOTE}}"
COMMIT_MESSAGE="$DEFAULT_COMMIT_MESSAGE"

PROJECT_NAME=""
FORCE=false
UPDATE_REMOTE=false
DISABLE_COLOR=false
NO_README=false
NO_COMMIT=false
POSITIONAL=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -V|--version)
            printf '%s\n' "$VERSION"
            exit 0
            ;;
        -n|--name)
            [[ $# -ge 2 ]] || die "Missing value for --name"
            PROJECT_NAME="$2"
            ;;
        --name=*)
            PROJECT_NAME="${1#*=}"
            ;;
        -d|--dev-dir)
            [[ $# -ge 2 ]] || die "Missing value for --dev-dir"
            DEV_DIR="$2"
            ;;
        --dev-dir=*)
            DEV_DIR="${1#*=}"
            ;;
        -D|--dropbox-dir)
            [[ $# -ge 2 ]] || die "Missing value for --dropbox-dir"
            DROPBOX_DIR="$2"
            ;;
        --dropbox-dir=*)
            DROPBOX_DIR="${1#*=}"
            ;;
        -b|--branch)
            [[ $# -ge 2 ]] || die "Missing value for --branch"
            BRANCH="$2"
            ;;
        --branch=*)
            BRANCH="${1#*=}"
            ;;
        -r|--remote)
            [[ $# -ge 2 ]] || die "Missing value for --remote"
            REMOTE_NAME="$2"
            ;;
        --remote=*)
            REMOTE_NAME="${1#*=}"
            ;;
        -m|--message)
            [[ $# -ge 2 ]] || die "Missing value for --message"
            COMMIT_MESSAGE="$2"
            ;;
        --message=*)
            COMMIT_MESSAGE="${1#*=}"
            ;;
        -f|--force)
            FORCE=true
            ;;
        --update-remote)
            UPDATE_REMOTE=true
            ;;
        --no-color)
            DISABLE_COLOR=true
            ;;
        --no-readme)
            NO_README=true
            ;;
        --no-commit)
            NO_COMMIT=true
            ;;
        --)
            shift
            while [[ $# -gt 0 ]]; do
                POSITIONAL+=("$1")
                shift
            done
            break
            ;;
        -* )
            die "Unknown option: $1"
            ;;
        * )
            POSITIONAL+=("$1")
            ;;
    esac
    case "$1" in
        -n|--name|-d|--dev-dir|-D|--dropbox-dir|-b|--branch|-r|--remote|-m|--message)
            shift
            ;;
    esac
    shift
done

if [[ "$DISABLE_COLOR" == true ]]; then
    NO_COLOR=1
    setup_colors
fi

if [[ -z "$PROJECT_NAME" && ${#POSITIONAL[@]} -gt 0 ]]; then
    PROJECT_NAME="${POSITIONAL[0]}"
    POSITIONAL=("${POSITIONAL[@]:1}")
fi

if [[ ${#POSITIONAL[@]} -gt 0 ]]; then
    die "Unexpected argument: ${POSITIONAL[0]}"
fi

if [[ -z "$PROJECT_NAME" ]]; then
    if [[ -t 0 ]]; then
        read -r -p "Project name: " PROJECT_NAME
    else
        die "Project name is required in non-interactive mode. Use --name."
    fi
fi

if [[ -z "$PROJECT_NAME" ]]; then
    die "Project name is required."
fi

if [[ ! "$PROJECT_NAME" =~ ^[A-Za-z0-9._-]+$ ]]; then
    die "Invalid project name. Use letters, numbers, dots, underscores, and hyphens."
fi

if ! git check-ref-format --branch "$BRANCH" >/dev/null 2>&1; then
    die "Invalid branch name: $BRANCH"
fi

if [[ ! "$REMOTE_NAME" =~ ^[A-Za-z0-9._-]+$ ]]; then
    die "Invalid remote name: $REMOTE_NAME"
fi

if [[ -z "$COMMIT_MESSAGE" ]]; then
    die "Commit message cannot be empty."
fi

DEV_DIR=$(expand_tilde "$DEV_DIR")
DROPBOX_DIR=$(expand_tilde "$DROPBOX_DIR")

PROJECT_DIR="$DEV_DIR/$PROJECT_NAME"
BARE_REPO_DIR="$DROPBOX_DIR/$PROJECT_NAME.git"

mkdir -p "$DEV_DIR"

if [[ -d "$PROJECT_DIR" ]]; then
    if [[ -n "$(find "$PROJECT_DIR" -mindepth 1 -maxdepth 1 -print -quit 2>/dev/null)" && "$FORCE" != true ]]; then
        die "Project folder exists and is not empty: $PROJECT_DIR (use --force to continue)"
    fi
else
    mkdir -p "$PROJECT_DIR"
fi

cd "$PROJECT_DIR"

if [[ "$NO_README" != true && ! -f "README.md" ]]; then
    cat > README.md << EOF
# $PROJECT_NAME

Project created with gitdropbox.
EOF
    ok "Created README.md"
fi

if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    warn "Existing git repository found"
else
    if git init -b "$BRANCH" >/dev/null 2>&1; then
        :
    else
        git init >/dev/null 2>&1
        git branch -M "$BRANCH"
    fi
    ok "Initialized git repository"
fi

current_branch=$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)
if [[ -z "$current_branch" ]]; then
    warn "Detached HEAD detected; branch rename skipped"
elif [[ "$current_branch" != "$BRANCH" ]]; then
    if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
        git checkout "$BRANCH" >/dev/null
        ok "Checked out existing branch '$BRANCH'"
    else
        git branch -M "$BRANCH"
        ok "Renamed branch to '$BRANCH'"
    fi
fi

mkdir -p "$DROPBOX_DIR"
if [[ -d "$BARE_REPO_DIR" ]]; then
    if [[ "$(git -C "$BARE_REPO_DIR" rev-parse --is-bare-repository 2>/dev/null || true)" != "true" ]]; then
        die "Path exists but is not a bare git repository: $BARE_REPO_DIR"
    fi
    warn "Bare repository already exists: $BARE_REPO_DIR"
else
    git init --bare "$BARE_REPO_DIR" >/dev/null
    ok "Created bare repository in Dropbox"
fi

target_url=$(canonicalize_repo_url "$BARE_REPO_DIR")
if git remote get-url "$REMOTE_NAME" >/dev/null 2>&1; then
    existing_url=$(git remote get-url "$REMOTE_NAME")
    existing_url_normalized=$(canonicalize_repo_url "$existing_url")

    if [[ "$existing_url_normalized" != "$target_url" ]]; then
        if [[ "$UPDATE_REMOTE" == true ]]; then
            warn "Remote '$REMOTE_NAME' points elsewhere; updating"
            git remote set-url "$REMOTE_NAME" "$BARE_REPO_DIR"
        else
            die "Remote '$REMOTE_NAME' points to '$existing_url'. Use --update-remote to repoint."
        fi
    fi
else
    git remote add "$REMOTE_NAME" "$BARE_REPO_DIR"
    ok "Added remote '$REMOTE_NAME'"
fi

if [[ "$NO_COMMIT" == true ]]; then
    warn "Skipping commit and push (--no-commit)"
    info "Project created at: $PROJECT_DIR"
    info "Dropbox repo: $BARE_REPO_DIR"
    exit 0
fi

git add -A
if git diff --cached --quiet; then
    warn "No changes to commit"
else
    if ! git commit -m "$COMMIT_MESSAGE"; then
        die "Commit failed. Configure git user.name and git user.email, then rerun."
    fi
    ok "Committed initial files"
fi

if git rev-parse --verify "${BRANCH}^{commit}" >/dev/null 2>&1; then
    git push -u "$REMOTE_NAME" "$BRANCH"
    ok "Pushed to Dropbox remote"
else
    warn "Branch '$BRANCH' has no commits; skipping push"
fi

info "Project created at: $PROJECT_DIR"
info "Dropbox repo: $BARE_REPO_DIR"
