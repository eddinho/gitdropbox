#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

# Color output when attached to a TTY, unless NO_COLOR is set.
if [[ -t 1 && -z "${NO_COLOR:-}" ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

die() {
    echo -e "${RED}Error:${NC} $*" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}Warning:${NC} $*"
}

ok() {
    echo -e "${GREEN}$*${NC}"
}

info() {
    echo "$*"
}

usage() {
    cat << 'EOF'
Usage: gitdropbox [OPTIONS] <project-name>

Create a local project and a bare git repository in Dropbox, then push.

Options:
  -h, --help               Show this help message
  -n, --name NAME          Project name (if not provided, you will be prompted)
  -d, --dev-dir PATH       Local projects folder (default: ~/dev)
  -D, --dropbox-dir PATH   Dropbox git folder (default: ~/Dropbox/Git)
  -b, --branch NAME        Branch name (default: main)
  -r, --remote NAME        Remote name (default: origin)
  -f, --force              Allow using an existing non-empty project folder
      --no-readme          Do not create README.md if missing
      --no-commit          Do not commit or push changes

Configuration (optional):
  git config --global gitdropbox.devdir ~/dev
  git config --global gitdropbox.dropboxdir ~/Dropbox/Git
  git config --global gitdropbox.branch main
  git config --global gitdropbox.remote origin
EOF
}

if ! command -v git >/dev/null 2>&1; then
    die "Git is not installed or not on PATH."
fi

DEFAULT_DEV_DIR="$HOME/dev"
DEFAULT_DROPBOX_DIR="$HOME/Dropbox/Git"
DEFAULT_BRANCH="main"
DEFAULT_REMOTE="origin"

CFG_DEV_DIR=$(git config --global gitdropbox.devdir || true)
CFG_DROPBOX_DIR=$(git config --global gitdropbox.dropboxdir || true)
CFG_BRANCH=$(git config --global gitdropbox.branch || true)
CFG_REMOTE=$(git config --global gitdropbox.remote || true)

DEV_DIR="${GITDROPBOX_DEV_DIR:-${CFG_DEV_DIR:-$DEFAULT_DEV_DIR}}"
DROPBOX_DIR="${GITDROPBOX_DROPBOX_DIR:-${CFG_DROPBOX_DIR:-$DEFAULT_DROPBOX_DIR}}"
BRANCH="${GITDROPBOX_BRANCH:-${CFG_BRANCH:-$DEFAULT_BRANCH}}"
REMOTE_NAME="${GITDROPBOX_REMOTE:-${CFG_REMOTE:-$DEFAULT_REMOTE}}"

PROJECT_NAME=""
FORCE=false
NO_README=false
NO_COMMIT=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -n|--name)
            shift
            [[ -n "${1:-}" ]] || die "Missing value for --name"
            PROJECT_NAME="$1"
            ;;
        -d|--dev-dir)
            shift
            [[ -n "${1:-}" ]] || die "Missing value for --dev-dir"
            DEV_DIR="$1"
            ;;
        -D|--dropbox-dir)
            shift
            [[ -n "${1:-}" ]] || die "Missing value for --dropbox-dir"
            DROPBOX_DIR="$1"
            ;;
        -b|--branch)
            shift
            [[ -n "${1:-}" ]] || die "Missing value for --branch"
            BRANCH="$1"
            ;;
        -r|--remote)
            shift
            [[ -n "${1:-}" ]] || die "Missing value for --remote"
            REMOTE_NAME="$1"
            ;;
        -f|--force)
            FORCE=true
            ;;
        --no-readme)
            NO_README=true
            ;;
        --no-commit)
            NO_COMMIT=true
            ;;
        --)
            shift
            break
            ;;
        -* )
            die "Unknown option: $1"
            ;;
        * )
            if [[ -z "$PROJECT_NAME" ]]; then
                PROJECT_NAME="$1"
            else
                die "Unexpected argument: $1"
            fi
            ;;
    esac
    shift
done

if [[ -z "$PROJECT_NAME" ]]; then
    read -r -p "Project name: " PROJECT_NAME
fi

if [[ -z "$PROJECT_NAME" ]]; then
    die "Project name is required."
fi

if [[ ! "$PROJECT_NAME" =~ ^[A-Za-z0-9._-]+$ ]]; then
    die "Invalid project name. Use letters, numbers, dots, underscores, and hyphens."
fi

PROJECT_DIR="$DEV_DIR/$PROJECT_NAME"
BARE_REPO_DIR="$DROPBOX_DIR/$PROJECT_NAME.git"

mkdir -p "$DEV_DIR"

if [[ -d "$PROJECT_DIR" ]]; then
    if [[ -n "$(ls -A "$PROJECT_DIR" 2>/dev/null)" && "$FORCE" != true ]]; then
        die "Project folder exists and is not empty: $PROJECT_DIR (use --force to continue)"
    fi
else
    mkdir -p "$PROJECT_DIR"
fi

cd "$PROJECT_DIR"

if [[ "$NO_README" != true && ! -f "README.md" ]]; then
    cat > README.md << EOF
# $PROJECT_NAME

Project created with gitdropbox.
EOF
    ok "Created README.md"
fi

if [[ -d ".git" ]]; then
    warn "Existing git repository found"
else
    if git init -b "$BRANCH" >/dev/null 2>&1; then
        :
    else
        git init >/dev/null 2>&1
        git branch -M "$BRANCH"
    fi
    ok "Initialized git repository"
fi

current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)
if [[ -n "$current_branch" && "$current_branch" != "HEAD" && "$current_branch" != "$BRANCH" ]]; then
    git branch -M "$BRANCH"
    ok "Renamed branch to '$BRANCH'"
fi

mkdir -p "$DROPBOX_DIR"
if [[ -d "$BARE_REPO_DIR" ]]; then
    warn "Bare repository already exists: $BARE_REPO_DIR"
else
    git init --bare "$BARE_REPO_DIR"
    ok "Created bare repository in Dropbox"
fi

if git remote | grep -qx "$REMOTE_NAME"; then
    existing_url=$(git remote get-url "$REMOTE_NAME")
    if [[ "$existing_url" != "$BARE_REPO_DIR" && "$existing_url" != "file://$BARE_REPO_DIR" ]]; then
        warn "Remote '$REMOTE_NAME' points elsewhere; updating"
        git remote set-url "$REMOTE_NAME" "$BARE_REPO_DIR"
    fi
else
    git remote add "$REMOTE_NAME" "$BARE_REPO_DIR"
fi

if [[ "$NO_COMMIT" == true ]]; then
    warn "Skipping commit and push (--no-commit)"
    exit 0
fi

git add -A
if git diff --cached --quiet; then
    warn "No changes to commit"
else
    git commit -m "Initial commit"
    ok "Committed initial files"
fi

if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
    git push -u "$REMOTE_NAME" "$BRANCH"
    ok "Pushed to Dropbox remote"
else
    warn "Branch '$BRANCH' has no commits; skipping push"
fi

info "Project created at: $PROJECT_DIR"
info "Dropbox repo: $BARE_REPO_DIR"
